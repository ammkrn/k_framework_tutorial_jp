# セルの内容を削除、保存、復旧すること

このレッスンで、環境・制御構造を変更する言語構造に望みの意味論を与えるため、セルの内容を削除したり保存したり復旧したりすることの単純さもやり方もを調べます。

最初に`halt`文の意味論を加えましょう。名前の通りに、プログラムの実行を即座に停止させる文になります。他のプログラムの通常停止と同じく、計算セル`<k>`が空いているようにしたいんです。直感的な定義にすれば、「`halt` が `<k>` セルの最上要素になると計算セルを出し尽くす」ということだけで十分です。

```
rule <k> halt; ~> _ => . </k>
```

この定義は書き換え矢印の貪欲性の典型例になります。前にレッスンでも言ったことがありますが、`=>` の一致する範囲を丸括弧で限っていかないと左にあり `<k>` セルを開けるタグまでの内容が矢印の右にあることとして書き換えされます。だから `halt` の定義で `halt;` 後のkセルにある内容は `_` だけで一致できます。丸括弧がないのでプログラムの残りが全体一つの物として扱われていんだからです。

`kompile`して、`sum-io.imp` を実行してみて下さい。停止する時に露出されてるコンフィギュレーションをよく見て下さい。レッスン４と違って停止状態は空の `<k>` セルを持っていますね。

前回も言ったが、現在使用している第二章の `imp` から遺伝したブロックを制御する意味論は正しくありません。問題となる所は `Block` から出る時の環境復です。`locals.imp` を実行して見たらたちまちの内に分かると思います。`locals.imp` の望ましい行動は `1 2 3 2 1` を出力することですけど `1 2 3 3 3` が出ますね。

修理するため、LAMBDA++と同様にブロックに入る前現在の環境のスナップショットを撮って、ブロックから出る時にスナップショットを復旧することにします。

```
    rule <k> {S} => S ~> Rho ...</k> <env> Rho </env>  [structural]
```

どの事情でも、あるセルの内容をそのままスナップショットで保存したければ、セルの全体を一致して一致された物体を備忘録としてどこかに置いておくことが出来ます。

環境を復旧する規則の意味論はこれ：

```
    rule <k> Rho => . ...</k> <env> _ => Rho </env>    [structural]
```

完成です! コンパイルして、`locals.imp` をもう一度実行して。今回はちゃんと働くはずです。気づかなかったかもしれませんが、実は、今回の環境復旧規則はLAMBDA++のとちょっと違います。LAMBDA++章で定義したのは:

```
rule <k> _ : Val ~> (Rho => .) ... </k> 
     <env> _ => Rho </env>
```

IMP++の表現はLAMBDA++と違って「無」(.)まで評価されるので、今回の環境復旧は先行している `_ : Val` と一致することはやりません。

実を言うとブロックの意味論との問題もスナップショットとの解答もそれぞれ複数の実現する方法があるので、オープンマインドを持って進行してください。ユースケースによってもっとも有用な解答が変わるかもしれないんだからです。

次回、メモリを共有するスレッドを動的に生む`spawn`構造の意味論を定義します。

