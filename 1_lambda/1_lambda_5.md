# ビルトインと補助条件を追加する

[元講座動画 [4'52"]](http://youtu.be/T1aI04q3l9U)


ここまで、識別子`Id`を既にLAMBDAに加えたが、`Id`は演算を何も持っていませんでした。このレッスンで、ビルトイン整数と真偽値ソートをLAMBDAに引き入れて、それらのソートの演算を定義する方法を調べます。規則が適用する事情を制御するための補助条件を定義する方法も学んでいきます。

Kツールは各々の定義にいくつかのビルトイン物を自動的に提供します。これらのビルトインは望みの構文カテゴリに加えるように使用可能になれます。デフォールトで提供されるビルトインは自分のユースケースト合わない場合は、自分のビルトインを定義することも出来ます。（提供されるビルトイン整数や演算は任意精度であります）

さて、整数・真偽値をここまでのLAMBDA定義に引き入れることはこのように行われます：

```
    syntax Val ::= Int | Bool
```

`Int` と `Bool` はビルトインと対応する非終端記号です。

新たに導入したビルトインを用いるため、言語に数学構造も加えることが必須です。今回、中置記号と普通の優先にします(掛け算とわり算のほうが足し算より強く結合します)。[SDF](http://www.syntax-definition.org/)に触発されて、構文構造の分裂記号として`|`の代わりに`>`を使うことで「`>`記号の前に定義されている構造の方が、後で定義されている構造より強く結合するようにしたい」という意味を伝えます。`lambda.k`で例示が見えます。


一つだけの残っている任務は新たに定義したLAMBDAの数学演算を引き入れたビルトイン整数ソートと繋ぐことです。`lambda.k`で見えるように、かなり分かりやすい書き直し規則で出来ます。識別することを容易にするため、kツールのビルトイン演算が使用される所に、そのビルトインの名前は語尾として接続しました。例えば、ビルトイン整数の足し算は`+Int`で書きました。

出来上がりに`lambda.k`をコンパイルして、簡単な数学表現を評価してみて下さい。`arithmetic.lambda`の中身が`(1+2*3)/4 <= 1`にすれば、`krun arithmetic.lambda`が思い通りに`true`に評価されます。整数演算は前に宣言した優先がパーサーに正しく反映されますね。

無駄な計算が渡されたら何が起こるかを試して見ましょう。古典的な0割にします。内容プログラムが`1/(2/3)`である`arithmetic-div-zero.lambda`を見てください。ここまでのLAMBDA定義の下で割り算は正確評価を使用し、`2/3`は`0`をになるのでこのプログラムは結局`1/0`まで評価されるはずです。kツールのバックエンドによってその結果はどのように解釈・処理されることが代わり舞うが、現在使用しているバックエンドならこのプログラムは`1/Int 0`に達して、そこで詰まっているようになってしまいます。

無駄な計算のせいで進めなくなることなどの事情は嫌ですから、その事情を避ける方法がいろいろあります。今回、除算の意味論を制御する規則に補助条件式を添付して、困る物になれない計算しか受けられないものにします。

```
 rule I1 / I2 => I1 /Int I2 requires I2 =/=Int 0
```
- 新たに加えた部分は `requires I2 =/=Int 0` ですね。

他の演算形式主義と同じく、kの補助条件式の目的は規則が当て嵌まる事情を濾過することです。補助条件式の概念は「論理」から由来します。形式な論理の文脈で、補助条件式はかなりやすいけど、論理前提は費用が高いんです。論理前提はそれ以上、費用が高い由来されたことが要りますが、補助条件式は元としている数学的な領域対のメタヴァリアブルで定義される条件としてあるだけです。

論理として見なされたら、kは何かの元と扱われている書き直し規則から新たな書き直し規則を由来するので、補助条件式の中に書き直し(`=>`が使用された)を持てません。この特徴はMaudeなどの書き直しエンジンとの相違です。

この限りのきっかけが二つあります:
1. 広域的な書き直し規則を評価可能なエンジンはkより遅く、かなり複雑なものになります。そのようなエンジンは再帰的(時々虱潰し式)書き直しセッションをしないとなりません。対照的に、kの補助条件式は効率的にいろんなバックエンドで解決可能な物です。
2. 一方、Kの「semantic definitional philosophy（意味論定義哲学）」は、論理前提が必要不可欠ではありません。それに伴って、提供されていません。

ビルトイン数学を持つのはかなり便利ですが、ラムダ表現や数学構造だけでプログラムを書くことはまだ面倒臭い。ですので、次のレッスンでif文、変数束縛、再起をLAMBDAに加える方法を学んでいきます。
